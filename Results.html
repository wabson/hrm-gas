<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title><?= title ?></title>
<style type="text/css">
body {
  font-size:          small;
  font-family:        Verdana, Helvetica, Arial, sans-serif;
  margin: 0;
  padding: 0;
}
h1 {
  font-size: 150%;
}
table {
  border: thin solid black;
  border-collapse: collapse;
  margin-top: 20px;
  margin-bottom: 20px;
}
caption {
  text-align: left;
  font-weight: bold;
}
th,td {
  text-align: left;
  border: thin solid gray;
  padding: 5px;
}
th {
  background-color:   #ccff99;
}
body {
}
#results-container {
  overflow: hidden;
  margin: 0px 10px;
}
#results {
  position: relative;
}
#results-data {
  visibility: hidden;
}
.scrolling {
  height: 100vh;
  overflow: hidden;
}
.scrolling #results {
  -webkit-animation: position_results <?= defaultScrollPeriod ?>s linear 0s infinite normal;
     -moz-animation: position_results <?= defaultScrollPeriod ?>s linear 0s infinite normal;
       -o-animation: position_results <?= defaultScrollPeriod ?>s linear 0s infinite normal;
          animation: position_results <?= defaultScrollPeriod ?>s linear 0s infinite normal;
}
@-webkit-keyframes position_results { from { top:0%; } to { top:-100%; }  }
   @-moz-keyframes position_results { from { top:0%; } to { top:-100%; }  }
     @-o-keyframes position_results { from { top:0%; } to { top:-100%; }  }
        @keyframes position_results { from { top:0%; } to { top:-100%; }  }
</style>
</head>
<body>
<div id="page">
<div id="results-container">
  <div id="results">
    <h1><?= title ?></h1>
    <div id="messages">Loading...</div>
    <div id="results-data">
      <div id="results-races"></div>
      <div id="results-pdtimes"></div>
      <div id="results-club-points"></div>
      <div id="results-lightning-points"></div>
    </div> <!-- end #results-data -->
  </div> <!-- end #results -->
</div> <!-- end #results-container -->
</div> <!-- end #page -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>

var key = "<?= key ?>", scroll = "<?= scroll ?>", newData = null, lastUpdated = null;

// The code in this function runs when the page is loaded.
$(function() {
  // Initial data load
  google.script.run.withSuccessHandler(onDataLoaded).getRaceResults(key);
});

function onDataLoaded(data) {
  $('#messages').hide();
  showData(data);
  if (scroll == "1" || scroll == "true") {
    console.log("Starting animation");
    startAnimation();
    // Check for updates
    window.setTimeout(checkLastUpdated, <?= checkInterval*1000 ?>);
  } else {
    $('#results-data').hide().css('visibility', 'visible').fadeIn(600);
  }
  if (data.lastUpdated) {
    lastUpdated = data.lastUpdated;
  }
}

function checkLastUpdated() {
  google.script.run.withSuccessHandler(onLastUpdatedSuccess).getLastUpdated(key);
}

function onLastUpdatedSuccess(updated) {
  if (updated !== null && updated != lastUpdated) {
    reloadData();
  }
  window.setTimeout(checkLastUpdated, <?= checkInterval*1000 ?>); // Queue up the function again
}

function reloadData() {
  console.log("Reload data");
  google.script.run.withSuccessHandler(onDataReloaded).getRaceResults(key);
}

function onDataReloaded(data) {
  if (scroll == "1" || scroll == "true") {
    $('#results').fadeOut(900, function() {
      stopAnimation();
      showData(data);
      $('#results').delay(900).show(0, function() {
        startAnimation();
      });
    });
  } else {
    showData(data);
  }
  if (data.lastUpdated) {
    lastUpdated = data.lastUpdated;
  }
}

function startAnimation() {
  var resultsHeight = $('#results').height(), screenHeight = window.innerHeight;
  if (resultsHeight > window.innerHeight) {
    // Set results to be just off the page and make them visible
    $('#results').css({
      paddingTop: '' + screenHeight + 'px',
      animationDuration: '' + ((resultsHeight + screenHeight) / 80) + 's' // 80 pixels per second, only works in FF for now
    });
    $('#results-data').css({
      visibility: 'visible'
    });
    // Start scrolling
    $('#page').addClass('scrolling');
    // Hard-code the container height to avoid messing up the percentage-based position on the child
    $('#results-container').css('height', '' + (resultsHeight + screenHeight) + 'px');
  }
  $('#results').addClass('scrolling-results');
}
function stopAnimation() {
  $('#results').removeClass('scrolling-results');
}

function showData(data) {
  if (data.races) {
    showResults(data);
  }
  if (data.pdTimes) {
    showPdTimes(data.pdTimes);
  }
  if (data.clubPoints) {
    showClubPoints(data.clubPoints);
  }
  if (data.lightningPoints) {
    showLightningPoints(data.lightningPoints);
  }
}

function showResults(data) {
  var races = data.races, div = $('#results-races'), html = "";
  div.empty();
  for (var i = 0; i < races.length; i++) {
    if (races[i].results && races[i].results.length > 0) {
      html += ('<table>')
      html += ('<caption>' + races[i].name + '</caption>');
      html += ('  <tr>');
      html += ('     <th>Position</th>');
      html += ('     <th>Name</th>');
      html += ('     <th>Club</th>');
      html += ('     <th>Class</th>');
      html += ('     <th>Div</th>');
      html += ('     <th>Time</th>');
      if (data.clubPoints && data.clubPoints.length)
        html += ('     <th>Points</th>');
      if (data.pdTimes && data.pdTimes.length)
        html += ('     <th>P/D</th>');
<? if (showNotes) { ?>
      html += ('     <th>Notes</th>');
<? } ?>
      html += ('  </tr>')
      for (var j = 0; j < races[i].results.length; ++j) {
        if (races[i].results[j].time) {
          html += ('  <tr>');
          html += ('     <td>' + races[i].results[j].posn + '</td>');
          html += ('     <td>' + races[i].results[j].names.join("<br />").toUpperCase() + '</td>');
          html += ('     <td>' + races[i].results[j].clubs.join("<br />").toUpperCase() + '</td>');
          html += ('     <td>' + races[i].results[j].classes.join("<br />").toUpperCase() + '</td>');
          html += ('     <td>' + races[i].results[j].divs.join("<br />") + '</td>');
          html += ('     <td>' + races[i].results[j].time + '</td>');
          if (data.clubPoints && data.clubPoints.length)
            html += ('     <td>' + races[i].results[j].points.join("<br />") + '</td>');
          if (data.pdTimes && data.pdTimes.length)
            html += ('     <td>' + races[i].results[j].pd.join("<br />") + '</td>');
     <? if (showNotes) { ?>
          html += ('     <td>' + races[i].results[j].notes.join("<br />") + '</td>');
     <? } ?>
          html += ('       </tr>');
        }
      }
      html += ('</table>');
    }
  }
  div.append(html);
}

function showPdTimes(pdTimes) {
  var div = $('#results-pdtimes'), html = "";
  div.empty();
  if (pdTimes && pdTimes.length > 0) {
    for (var i = 0; i < pdTimes.length; ++i) {
      html += ('<table>');
      html += ('<caption>P/D divs ' + pdTimes[i].title.split("").join(", ") + ' K1</caption>');
      html += ('  <tbody><tr>');
      html += ('     <th>P/D</th>');
      html += ('     <th>Time</th>');
      html += ('  </tr>');
      for (var j = 0; j < pdTimes[i].times.length; ++j) {
        html += ('  <tr>');
        html += ('     <td>' + pdTimes[i].times[j].name + '</td>');
        html += ('     <td>' + pdTimes[i].times[j].time + '</td>');
        html += ('  </tr>');
      }
      html += ('</tbody></table>');
    }
  }
  div.append(html);
}

function showClubPoints(clubPoints) {
  var div = $('#results-club-points'), html = "";
  div.empty();
  if (clubPoints && clubPoints.length > 0) {
    html += ('<table>');
    html += ('<caption>Club points</caption>');
    html += ('  <tbody><tr>');
    html += ('     <th>Club</th>');
    html += ('     <th>Points</th>');
    html += ('     <th>Overall</th>');
    html += ('  </tr>');
    for (var i = 0; i < clubPoints.length; ++i) {
      html += ('  <tr>');
      html += ('     <td>' + clubPoints[i].name + '</td>');
      html += ('     <td>' + clubPoints[i].totalPoints + '</td>');
      html += ('     <td>' + clubPoints[i].haslerPoints + '</td>');
      html += ('  </tr>');
    }
    html += ('</tbody></table>');
  }
  div.append(html);
}

function showLightningPoints(lightningPoints) {
  var div = $('#results-lightning-points'), html = "";
  div.empty();
  if (lightningPoints && lightningPoints.length > 0) {
    html += ('<table>');
    html += ('<caption>Lightning points</caption>');
    html += ('  <tbody><tr>');
    html += ('     <th>Club</th>');
    html += ('     <th>Points</th>');
    html += ('  </tr>');
    for (var i = 0; i < lightningPoints.length; ++i) {
      html += ('  <tr>');
      html += ('     <td>' + lightningPoints[i].name + '</td>');
      html += ('     <td>' + lightningPoints[i].totalPoints + '</td>');
      html += ('  </tr>');
    }
    html += ('</tbody></table>');
  }
  div.append(html);
}
</script>
</body>
</html>
