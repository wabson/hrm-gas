<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('forms.head.include'); ?>
    <?!= include('sidebar.head.include'); ?>
    <style type="text/css">
        #results-form, #add-entry-messages {
            margin-top: 16px;
        }
        #crew-list-form {
            margin-top: 24px;
        }
        #rankings-search, #manual-entry-form {
            margin-top: 21px;
        }
        form table {
            width: 100%;
            border-collapse: collapse;
        }
        tr:last-child > th {
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #ebebeb;
        }
        span.tab {
            text-transform: uppercase;
            padding: 4px 5px;
            font-size: 1.1em;
        }
        span.tab.selected {
            font-weight: bold;
            border-bottom: 2px solid #d22;
        }
        span.tab a {
            color: #222;
            text-decoration: none;
        }
        form table th, form table td {
            padding: 2px;
        }
        form thead th {
            white-space: nowrap;
        }
        #add-entry {
            margin-left: 12px;
        }
        #add-entry-widget-results p {
            margin: 0.4em 0;
        }
        #manual-entry-form select {
            width: 80px;
        }
    </style>
</head>
<body>
<?!= include('forms.script.include'); ?>
<?!= include('component.rankings-search'); ?>
<?!= include('component.crew-list'); ?>
<script>
    var spreadSheetId = '<?= spreadsheetId ?>';
</script>
<div class="sidebar-content">
    <div id="add-entry-widget"></div>
</div>
<script>

    $(function() {

        var headings = ['Surname', 'First name', 'Club', 'Class', 'Division', 'BCU Number', 'Expiry'];

        var displayCols = ['Name', 'Class', 'Div', 'BCU #', 'Expiry'];
        var nameCellRenderer = function(value, index, object) {
            return object['Surname'] + ', ' + object['First name'];
        };
        var customCellRenders = {
            'Name': nameCellRenderer,
            'Class': function(value, index, object) {
                return object['Club'] + ', ' + object['Class'];
            },
            'Div': function(value, index, object) {
                return object['Division'];
            },
            'BCU #': function(value, index, object) {
                return object['BCU Number'];
            },
            'Expiry': function(value) {
                var parts = new Date(value).toDateString().split(' ');
                return [parts[2].replace(/^0/, ''), parts[1], parts[3]].join(' ');
            }
        };

        var AddEntryView = BaseComponent.extend({

            events: {
                'click div.results a': 'onAddedCrewClick'
            },

            initialize: function () {

                var rankingDispatcher = _.extend({}, Backbone.Events);
                var manualEntryDispatcher = _.extend({}, Backbone.Events);
                this.crewDispatcher = _.extend({}, Backbone.Events);
                var crewData = new TableData({
                    columns: headings,
                    values: []
                });

                this.classListData = new SelectListData({
                    options: [['S', 'Senior']]
                });
                this.clubListData = new SelectListData({
                    options: [['RIC', 'Richmond'], ['ROY', 'Royal']]
                });
                this.divisionsListData = new SelectListData({
                    options: [['1', 'Div1'], ['2', 'Div2']]
                });
                this.search = new RankingsSearch({
                    model: {},
                    id: 'rankings-search',
                    dispatcher: rankingDispatcher,
                    className: 'searchRankings',
                    spreadsheetId: spreadSheetId,
                    columns: headings,
                    displayColumns: displayCols,
                    cellRenderers: customCellRenders,
                    classListData: this.classListData,
                    clubListData: this.clubListData,
                    divisionsListData: this.divisionsListData
                });
                this.manualForm = new DataForm({
                    id: 'manual-entry-form',
                    dispatcher: manualEntryDispatcher,
                    blocks: [
                        new FormBlock({
                            controls: [
                                new FormGroupInline({
                                    controls: [
                                        new FormField({
                                            name: 'Surname',
                                            className: 'surname',
                                            type: 'text',
                                            label: 'Surname',
                                            required: true
                                        })
                                    ]
                                }),
                                new FormGroupInline({
                                    controls: [
                                        new FormField({
                                            name: 'First name',
                                            className: 'first-name',
                                            type: 'text',
                                            label: 'First name',
                                            required: true
                                        })
                                    ]
                                })
                            ]
                        }),
                        new FormBlock({
                            controls: [
                                new FormGroupInline({
                                    controls: [
                                        new FormField({
                                            name: 'BCU Number',
                                            type: 'text',
                                            label: 'BCU Number',
                                            required: true
                                        })
                                    ]
                                }),
                                new FormGroupInline({
                                    controls: [
                                        new FormField({
                                            name: 'Expiry',
                                            type: 'date',
                                            label: 'Expiry',
                                            required: true
                                        })
                                    ]
                                })
                            ]
                        }),
                        new FormBlock({
                            controls: [
                                new FormGroupInline({
                                    controls: [
                                        new FormSelectField({
                                            fieldId: 'select-class',
                                            label: 'Class',
                                            selectList: new SelectList({
                                                id: 'select-class',
                                                name: 'Class',
                                                model: this.classListData,
                                                placeholder: 'Select',
                                                required: true
                                            })
                                        })
                                    ]
                                }),
                                new FormGroupInline({
                                    controls: [
                                        new FormSelectField({
                                            fieldId: 'select-club',
                                            label: 'Club',
                                            selectList: new SelectList({
                                                id: 'select-club',
                                                name: 'Club',
                                                model: this.clubListData,
                                                placeholder: 'Select',
                                                required: true
                                            })
                                        })
                                    ]
                                }),
                                new FormGroupInline({
                                    controls: [
                                        new FormSelectField({
                                            fieldId: 'select-division',
                                            label: 'Division',
                                            selectList: new SelectList({
                                                id: 'select-division',
                                                name: 'Division',
                                                model: this.divisionsListData,
                                                placeholder: 'Select',
                                                required: true
                                            })
                                        })
                                    ]
                                })
                            ]
                        }),
                        new FormBlock({
                            controls: [
                                new FormButton({
                                    id: 'add-manual',
                                    type: 'submit',
                                    text: 'Add to Crew'
                                })
                            ]
                        })
                    ]
                });

                var crewTable = new DataTable({
                    id: 'crew-members',
                    dispatcher: this.crewDispatcher,
                    data: crewData,
                    displayColumns: displayCols,
                    cellRenderers: customCellRenders
                });

                this.raceListData = new SelectListData({
                    options: []
                });

                this.crewForm = new DataTableForm({
                    id: 'crew-list-form',
                    dispatcher: this.crewDispatcher,
                    blocks: [
                        new FormBlock({
                            controls: [ crewTable ]
                        }),
                        new FormBlock({
                            controls: [
                                new SelectList({
                                    title: 'Race',
                                    name: 'race',
                                    model: this.raceListData
                                }),
                                new FormButton({
                                    id: 'add-entry',
                                    className: 'action',
                                    type: 'submit',
                                    text: 'Add Entry'
                                }),
                                new FormButton({
                                    id: 'clear-crew',
                                    type: 'reset',
                                    text: 'Clear'
                                })
                            ]
                        })
                    ]
                });
                var tabsDispatcher = _.extend({}, Backbone.Events);
                this.tabs = new TabsList({
                    dispatcher: tabsDispatcher,
                    tabs: {
                        'Search Rankings': this.search,
                        'Manual Entry': this.manualForm
                    }
                });

                rankingDispatcher.bind('submit', function(payload) {
                    var newRows = payload.tableData['rankings-search-results'];
                    crewData.set('values', crewData.get('values').concat(newRows));
                    rankingDispatcher.trigger('submitSuccess', this);
                }, this);
                rankingDispatcher.bind('editMember', function(payload) {
                    manualEntryDispatcher.trigger('formData', {
                        values: payload.selected[0]
                    });
                    tabsDispatcher.trigger('select', {
                        id: this.manualForm.el.id
                    });
                }, this);

                manualEntryDispatcher.bind('submit', function(payload) {
                    var newRows = [payload.data];
                    crewData.set('values', crewData.get('values').concat(newRows));
                    manualEntryDispatcher.trigger('submitSuccess', this);
                }, this);

                this.crewDispatcher.bind('submit', this.onCrewFormSubmit, this);
            },

            render: function () {
                this.$el.empty().append([this.tabs.render().$el, this.search.render().$el, this.manualForm.render().$el, this.crewForm.render().$el, this.createDiv_('-messages'), this.createDiv_('-results', {
                    className: 'results'
                })]);
                this.loadRaceNames_();
                this.loadRaceInfo_();
            },

            loadRaceNames_: function() {
                google.script.run.withSuccessHandler(_.bind(this.onRaceNamesLoaded, this)).getRaceSheetNamesHTML(spreadSheetId);
            },

            loadRaceInfo_: function() {
                google.script.run.withSuccessHandler(_.bind(this.onRaceInfoLoaded, this)).sidebar_entries_race_info(spreadSheetId);
            },

            onRaceNamesLoaded: function(resp) {
                this.raceListData.set('options', ['Auto'].concat(resp));
                this.search.searchForm.setFormFieldsDisabled(false).focus();
            },

            onRaceInfoLoaded: function(resp) {
                this.classListData.set('options', resp.classes);
                this.clubListData.set('options', _.map(resp.clubs, function(clubArr) {
                    return [clubArr[1], clubArr[0]];
                }));
                this.divisionsListData.set('options', resp.divisions);
            },

            onCrewFormSubmit: function(payload) {
                var raceName = payload.data.race, crewMembers = payload.tableData['crew-members'];
                google.script.run
                        .withSuccessHandler(_.bind(this.onAddCrewSuccess, this))
                        .withFailureHandler(_.bind(this.onAddCrewFailure, this))
                        .withUserObject({
                            crewMembers: crewMembers
                        })
                        .sidebar_entries_add(
                                spreadSheetId,
                                crewMembers,
                                headings,
                                raceName
                        );
                this.$('#' + this.el.id + '-messages').empty();
            },

            onAddCrewSuccess: function(result, ctx) {
                this.crewDispatcher.trigger('submitSuccess');
                this.$('.results')
                        .prepend('<p>Added <a href="#" data-row-num="' + result.rowNumber + '" data-sheet-name="' +
                                result.sheetName + '">' + result.boatNumber + ' ' + this.crewNames_(ctx.crewMembers) +
                                '</a> in ' + result.sheetName + '</p>');
                this.search.searchForm.focus();
            },

            onAddCrewFailure: function(result) {
                this.$('#' + this.el.id + '-messages').html('Sorry, a problem occurred adding the crew to the selected race');
                this.crewDispatcher.trigger('submitFailure');
            },

            crewNames_: function(members) {
                return members.map(function(o) {
                    return nameCellRenderer(null, null, o);
                }).join(' / ');
            },

            onAddedCrewClick: function(event) {
                var sheetName = $(event.target).attr('data-sheet-name'), rowNumber = $(event.target).attr('data-row-num');
                event.preventDefault();
                google.script.run
                        .withSuccessHandler(function() {
                            google.script.host.editor.focus();
                        })
                        .sidebar_entries_link(sheetName, rowNumber);
            }

        });

        new AddEntryView({
            el: '#add-entry-widget'
        }).render();

    });
</script>
<!--=include mock-services.html -->

</body>
</html>