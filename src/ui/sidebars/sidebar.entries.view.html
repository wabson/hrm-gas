<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('forms.head.include'); ?>
    <?!= include('sidebar.head.include'); ?>
    <style type="text/css">
        #crew-list-form, #results-form, #add-entry-messages {
            margin-top: 10px;
        }
        form table {
            width: 100%;
            border-collapse: collapse;
        }
        tr:last-child > th {
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #ebebeb;
        }
        form table th, form table td {
            padding: 2px;
        }
        form thead th {
            white-space: nowrap;
        }
        #add-entry {
            margin-left: 12px;
        }
        #add-entry-messages p {
            margin: 0.4em 0;
        }
    </style>
</head>
<body>
<?!= include('forms.script.include'); ?>
<?!= include('component.rankings-search'); ?>
<?!= include('component.crew-list'); ?>
<script>
    var spreadSheetId = '<?= spreadsheetId ?>';
</script>
<div class="sidebar-content">
    <div id="add-entry-widget"></div>
    <div id="add-entry-messages"></div>
</div>
<script>

    $(function() {

        var headings = ['Surname', 'First name', 'Club', 'Class', 'Division', 'BCU Number', 'Expiry'];

        var displayCols = ['Name', 'Class', 'Div', 'BCU #', 'Expiry'];
        var nameCellRenderer = function(value, index, object) {
            return object['Surname'] + ', ' + object['First name'];
        };
        var customCellRenders = {
            'Name': nameCellRenderer,
            'Class': function(value, index, object) {
                return object['Club'] + ', ' + object['Class'];
            },
            'Div': function(value, index, object) {
                return object['Division'];
            },
            'BCU #': function(value, index, object) {
                return object['BCU Number'];
            }
        };

        var AddEntryView = Backbone.View.extend({

            initialize: function (options) {

                var rankingDispatcher = _.extend({}, Backbone.Events);
                this.crewDispatcher = _.extend({}, Backbone.Events);
                var crewData = new TableData({
                    columns: headings,
                    values: []
                });

                this.search = new RankingsSearch({
                    model: {},
                    id: 'rankings-search',
                    dispatcher: rankingDispatcher,
                    className: 'searchRankings',
                    spreadsheetId: spreadSheetId,
                    columns: headings,
                    displayColumns: displayCols,
                    cellRenderers: customCellRenders
                });

                var crewTable = new DataTable({
                    id: 'crew-members',
                    dispatcher: this.crewDispatcher,
                    data: crewData,
                    displayColumns: displayCols,
                    cellRenderers: customCellRenders
                });

                this.raceListData = new RaceListData({
                    options: []
                });

                this.crewForm = new DataTableForm({
                    id: 'crew-list-form',
                    dispatcher: this.crewDispatcher,
                    blocks: [
                        new FormBlock({
                            controls: [ crewTable ]
                        }),
                        new FormBlock({
                            controls: [
                                new SelectList({
                                    title: 'Race',
                                    name: 'race',
                                    model: this.raceListData
                                }),
                                new FormButton({
                                    id: 'add-entry',
                                    className: 'action',
                                    type: 'submit',
                                    text: 'Add Entry'
                                }),
                                new FormButton({
                                    id: 'clear-crew',
                                    type: 'reset',
                                    text: 'Clear'
                                })
                            ]
                        })
                    ]
                });

                rankingDispatcher.bind('submit', function(payload) {
                    var newRows = payload.tableData['rankings-search-results'];
                    crewData.set('values', crewData.get('values').concat(newRows));
                    rankingDispatcher.trigger('submitSuccess');
                }, this);

                this.crewDispatcher.bind('submit', this.onCrewFormSubmit, this);
            },

            createMessagesDiv_: function() {
                return $(document.createElement('div')).attr('id', this.el.id  + '-messages');
            },

            render: function () {
                this.$el.empty().append([this.search.render().$el, this.crewForm.render().$el, this.createMessagesDiv_()]);
                this.loadRaceNames_();
            },

            loadRaceNames_: function() {
                google.script.run.withSuccessHandler(_.bind(this.onRaceNamesLoaded, this)).getRaceSheetNamesHTML(spreadSheetId);
            },

            onRaceNamesLoaded: function(resp) {
                this.raceListData.set('options', ['Auto'].concat(resp));
            },

            onCrewFormSubmit: function(payload) {
                var raceName = payload.data.race, crewMembers = payload.tableData['crew-members'];
                google.script.run
                        .withSuccessHandler(_.bind(this.onAddCrewSuccess, this))
                        .withFailureHandler(_.bind(this.onAddCrewFailure, this))
                        .withUserObject({
                            crewMembers: crewMembers
                        })
                        .sidebar_entries_add(
                                spreadSheetId,
                                crewMembers,
                                headings,
                                raceName
                        );
            },

            onAddCrewSuccess: function(result, ctx) {
                this.crewDispatcher.trigger('submitSuccess');
                $('#add-entry-messages')
                        .prepend('<p>Added <a href="#" id="boat-link-' + result.boatNumber + '">' + result.boatNumber + ' ' + this.crewNames_(ctx.crewMembers) + '</a> in ' +
                                result.sheetName + '</p>')
                        .find('a#boat-link-' + result.boatNumber).click(_.bind(function (event) {
                            event.preventDefault();
                            this.onAddedCrewClick(result.sheetName, result.rowNumber);
                        }), this);
            },

            onAddCrewFailure: function(result) {
                this.$('#' + this.el.id + '-messages').html('Sorry, a problem occurred adding the crew to the selected race');
                this.crewDispatcher.trigger('submitFailure');
            },

            crewNames_: function(members) {
                return members.map(function(o) {
                    return nameCellRenderer(null, null, o);
                }).join(' / ');
            },

            onAddedCrewClick: function(sheetName, rowNumber) {
                google.script.run
                        .withSuccessHandler(function() {
                            google.script.host.editor.focus();
                        })
                        .sidebar_entries_link(sheetName, rowNumber);
            }

        });

        new AddEntryView({
            el: '#add-entry-widget'
        }).render();

    });
</script>
<!--=include mock-services.html -->

</body>
</html>