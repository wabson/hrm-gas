<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('forms.head.include'); ?>
    <?!= include('sidebar.head.include'); ?>
    <style type="text/css">
        #crew-list-form, #results-form, #add-entry-messages {
            margin-top: 10px;
        }
        form table {
            width: 100%;
            border-collapse: collapse;
        }
        tr:last-child > th {
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #ebebeb;
        }
        form table th, form table td {
            padding: 2px;
        }
    </style>
</head>
<body>
<?!= include('forms.script.include'); ?>
<script>
    var spreadSheetId = '<?= spreadsheetId ?>';
</script>
<div class="sidebar-content">

    <?!= include('component.rankings-search'); ?>
    <?!= include('component.crew-list'); ?>
    <div class="block form-group">
        <div id="add-entry-messages"></div>
    </div>
</div>
<script>

    function addCrewToRace(obj) {
        var raceName = obj.raceName, selected = obj.crewMembers;
        google.script.run
                .withSuccessHandler(onAddCrewSuccess)
                .withFailureHandler(onAddCrewFailure)
                .onHTMLAddEntryClick(
                        spreadSheetId,
                        selected[0],
                        selected.length > 1 ? selected[1] : null,
                        raceName
                );
    }

    function onAddCrewSuccess(result) {
        $('#crew-list-form').trigger('crewSubmitSuccess');
        $('#rankings-search').trigger('crewSubmitSuccess');
        $('#add-entry-messages').html('Added ' + result.boatNumber + ' ' + result.crewName + ' in ' +
                result.sheetName);
    }

    function onAddCrewFailure(result) {
        $('#crew-list-form').trigger('crewSubmitFailure');
    }

    $(function() {
        $('#rankings-search').on('crewMemberAdd', function(e, customObj) {
            $('#crew-list-form').trigger('crewMemberAdd', customObj);
        });
        $('#crew-list-form').on('crewSubmit', function(e, customObj) {
            addCrewToRace(customObj);
        });
    });
</script>
<!--=include mock-services.html -->

</body>
</html>