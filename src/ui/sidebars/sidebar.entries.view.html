<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('forms.head.include'); ?>
    <?!= include('sidebar.head.include'); ?>
    <style type="text/css">
        #crew-list-form, #results-form, #add-entry-messages {
            margin-top: 10px;
        }
        form table {
            width: 100%;
            border-collapse: collapse;
        }
        tr:last-child > th {
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #ebebeb;
        }
        form table th, form table td {
            padding: 2px;
        }
        form thead th {
            white-space: nowrap;
        }
    </style>
</head>
<body>
<?!= include('forms.script.include'); ?>
<script>
    var spreadSheetId = '<?= spreadsheetId ?>';
</script>
<div class="sidebar-content">

    <?!= include('component.rankings-search'); ?>
    <?!= include('component.crew-list'); ?>
    <div class="block form-group">
        <div id="add-entry-messages"></div>
    </div>
</div>
<script>

    $(function() {

        var headings = ['Surname', 'First name', 'Club', 'Class', 'Division', 'BCU Number', 'Expiry'];

        function renderNameValue(values) {
            return values[headings.indexOf('Surname')] + ', ' + values[headings.indexOf('First name')];
        }

        function renderClassValue(values) {
            return values[headings.indexOf('Club')] + ', ' + values[headings.indexOf('Class')];
        }

        var headingsRenderer = function(names) {
            var modifiedCols = ['Name', 'Class', 'Div', 'BCU #', 'Expiry'];
            return $.map(modifiedCols, function (colName) {
                return '<th>' + colName + '</th>';
            });
        }, dataRenderer = function(values) {
            var modifiedValues = values.slice();
            modifiedValues.splice(0, 2, [renderNameValue(values)]);
            modifiedValues.splice(1, 2, [renderClassValue(values)]);
            return modifiedValues.map(function (value) {
                return '<td>' + value + '</td>';
            });
        };

        function addCrewToRace(obj) {
            var raceName = obj.raceName, crewMemberObj, crewMembers = $.map(obj.crewMembers, function(arr) {
                crewMemberObj = {};
                $.each(headings, function(index, heading) {
                    crewMemberObj[heading] = arr[index];
                });
                return crewMemberObj;
            });
            google.script.run
                    .withSuccessHandler(onAddCrewSuccess)
                    .withFailureHandler(onAddCrewFailure)
                    .withUserObject({
                        crewMembers: crewMembers
                    })
                    .sidebar_entries_add(
                            spreadSheetId,
                            crewMembers,
                            headings,
                            raceName
                    );
        }

        function crewName_(members) {
            return members.map(function(o) {
                return o['Surname'] + ', ' + o['First name'];
            }).join(' / ');
        }

        function onAddCrewSuccess(result, ctx) {
            $('#crew-list-form').trigger('crewSubmitSuccess');
            $('#rankings-search').trigger('crewSubmitSuccess');
            $('#add-entry-messages').html('Added <a href="#">' + result.boatNumber + ' ' + crewName_(ctx.crewMembers) + '</a> in ' +
                    result.sheetName);
            $('#add-entry-messages').find('a').click(function (event) {
                event.preventDefault();
                onAddedCrewClick(result.sheetName, result.rowNumber);
            });
        }

        function onAddCrewFailure(result) {
            $('#crew-list-form').trigger('crewSubmitFailure');
        }

        function onAddedCrewClick(sheetName, rowNumber) {
            google.script.run
                    .withSuccessHandler(function() {
                        google.script.host.editor.focus();
                    })
                    .sidebar_entries_link(sheetName, rowNumber);
        }

        $('#rankings-search')
                .trigger('init', {
                    headings: headings,
                    headingsRenderer: headingsRenderer,
                    dataRenderer: dataRenderer
                })
                .on('crewMemberAdd', function(e, customObj) {
                    $('#crew-list-form').trigger('crewMemberAdd', customObj);
                });
        $('#crew-list-form')
                .trigger('init', {
                    headings: headings,
                    headingsRenderer: headingsRenderer,
                    dataRenderer: dataRenderer
                })
                .on('crewSubmit', function(e, customObj) {
                    addCrewToRace(customObj);
                });
    });
</script>
<!--=include mock-services.html -->

</body>
</html>