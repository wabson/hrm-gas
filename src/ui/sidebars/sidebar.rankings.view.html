<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('forms.head.include'); ?>
    <?!= include('sidebar.head.include'); ?>
    <style type="text/css">
        #rankings-update {
            margin: 1em 0;
            display: none;
        }
        .message-box p {
            margin: 0 0 0;
        }
        .message-box p.icon:before, .message p.icon:before {
            color: rgba(0, 0, 0, 0.54);
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;  /* Preferred icon size */
            display: block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            /* Support for all WebKit browsers. */
            -webkit-font-smoothing: antialiased;
            /* Support for Safari and Chrome. */
            text-rendering: optimizeLegibility;
            /* Support for Firefox. */
            -moz-osx-font-smoothing: grayscale;
            /* Support for IE. */
            font-feature-settings: 'liga';
            float: left;
            width: 24px;
            padding-right: 5px;
        }
        p.icon-info:before {
            content: 'info outline';
        }
        .message-box p.icon-error:before, .message p.icon-error:before {
            color: #dd4b39;
            content: 'error';
        }
        .message p.icon-info {
            color: #666;
            vertical-align: middle;
        }
        .message p.icon-info:before {
            color: #999;
        }
    </style>
</head>
<body>
<div class="sidebar-content">
    <div id="rankings-sidebar">
        <div id="rankings-messages" class="error"></div>
        <p id="rankings-info"></p>
        <div id="rankings-update"><p class="icon icon-info"></p></div>
        <form id="import-form">
            <div class="block form-group">
                <input id="btn-import" type="submit" value="Update Rankings" class="action" />
            </div>
            <div class="block form-group">
                <div id="import-messages"></div>
            </div>
        </form>
        <h2>Search Rankings</h2>
        <div id="rankings-search"></div>
        <div id="rankings-search-errors" class="message error"></div>
    </div>
</div>

<?!= include('forms.script.include'); ?>
<?!= include('components.base'); ?>
<?!= include('components.forms'); ?>
<?!= include('components.rankings-search'); ?>
<script>
    var spreadSheetId = '<?= spreadsheetId ?>';

    var RankingsView = BaseComponent.extend({

        events: {
            'submit #import-form': 'onImportClick'
        },

        initialize: function (options) {

            this.spreadsheetId = options.spreadsheetId;

            var headings = ['Surname', 'First name', 'Club', 'Class', 'Division', 'BCU Number', 'Expiry'];
            var displayCols = ['Name', 'Class', 'Div', 'BCU #', 'Expiry'];
            var classListData = new SelectListData({
                options: []
            });
            var clubListData = new SelectListData({
                options: []
            });
            var rankingDetails = new HaslerRankingDetails({
                classListData: classListData,
                clubListData: clubListData
            });
            this.rankingDispatcher = _.extend({}, Backbone.Events);
            this.search = new RankingsSearch({
                el: '#rankings-search',
                dispatcher: this.rankingDispatcher,
                spreadsheetId: spreadSheetId,
                columns: headings,
                displayColumns: displayCols,
                cellRenderers: rankingDetails.getCellRenders(),
                classListData: this.classListData,
                clubListData: this.clubListData,
                divisionsListData: this.divisionsListData,
                resultsButtons: [
                    new FormButton({
                        id: 'add-member',
                        type: 'submit',
                        text: 'Insert into Sheet',
                        className: 'action'
                    }),
                    new FormButton({
                        type: 'reset',
                        text: 'Clear'
                    })
                ]
            });
            this.rankingDispatcher.bind('submit', function(payload) {
                $('#rankings-search-errors').empty();
                var newRows = payload.tableData['rankings-search-results'];
                google.script.run
                        .withSuccessHandler(_.bind(this.onInsertRowsSuccess, this))
                        .withFailureHandler(_.bind(this.onInsertRowsFailure, this))
                        .sidebar_rankings_insert(newRows, headings);
            }, this);
        },

        render: function() {
            this.$('#rankings-search').empty().append(this.search.render().$el);
            google.script.run
                    .withSuccessHandler(_.bind(this.onSpreadsheetInfoSuccess, this))
                    .withFailureHandler(_.bind(this.onFailure, this))
                    .sidebar_rankings_info(this.spreadsheetId);
            return this;
        },

        onImportClick: function(event) {
            event.preventDefault();
            var $form = $(event.target);
            var formData = $form.serializeObject();
            $form.disableSubmit();
            google.script.run
                    .withSuccessHandler(_.bind(this.onImportRankingsSuccess, this))
                    .withFailureHandler(_.bind(this.onImportRankingsFailure, this))
                    .sidebar_rankings_import(this.spreadsheetId, formData);
        },

        formatSummary: function(data) {
            if (typeof data.rankingsSize == 'number') {
                var text = data.rankingsSize > 0 ? ('Spreadsheet has ' +
                (data.rankingsSize.toLocaleString ? data.rankingsSize.toLocaleString(): data.rankingsSize) +
                ' known marathon rankings') : 'No marathon rankings have been imported';
                if (data.lastUpdated) {
                    text += ', last updated on ' + data.lastUpdated;
                }
                return text;
            } else {
                return 'A problem occurred when looking up the rankings';
            }
        },
        onSpreadsheetInfoSuccess: function(data) {
            var lastUpdated = data.lastUpdated;

            this.$('#rankings-info').html(this.formatSummary(data), false);

            google.script.run
                    .withSuccessHandler(_.bind(function (webLastUpdated) {
                        if (webLastUpdated !== null && lastUpdated !== null && webLastUpdated != lastUpdated) {
                            this.$('#rankings-update')
                                    .css('display', 'block')
                                    .removeClass()
                                    .addClass('message-box info')
                                    .find('p')
                                    .html('A new version of the ranking list may be available updated ' + webLastUpdated);
                        } else {
                            this.$('#rankings-update')
                                    .css('display', 'block')
                                    .removeClass()
                                    .addClass('message info')
                                    .find('p')
                                    .html('You have the latest version of the ranking list');
                        }
                    }, this))
                    .withFailureHandler(_.bind(this.onFailure, this))
                    .sidebar_rankings_last_updated(this.spreadsheetId)
        },
        onImportRankingsSuccess: function(data) {
            this.onSpreadsheetInfoSuccess(data);
            this.$('#import-form').restoreSubmit();
        },
        onImportRankingsFailure: function(error) {
            this.$('#rankings-messages').html('Sorry, an error occurred importing the ranking data. Please try again later.');
            this.$('#import-form').restoreSubmit();
        },
        onFailure: function (error) {
            this.$('#rankings-messages').html('Sorry, an error occurred. Please try again later.');
        },
        onInsertRowsSuccess: function(data) {
            this.rankingDispatcher.trigger('submitSuccess', this);
        },
        onInsertRowsFailure: function(err) {
            this.$('#rankings-search-errors').html('<p class="icon icon-error">Could not insert crew member: ' + err.message+ '</p>');
            this.rankingDispatcher.trigger('submitFailure', this);
        }

    });

    $(function() {

        new RankingsView({
            el: '#rankings-sidebar',
            spreadsheetId: spreadSheetId
        }).render();

    });
</script>
<!--=include mock-services.html -->

</body>
</html>