<style type="text/css">
    form thead th {
        font-weight: 700;
    }
</style>
<form id="crew-list-form">
    <div id="users-contain">
        <div class="block form-group">
            <table id="crew-members">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Class</th>
                    <th>Club</th>
                    <th>Division</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="block form-group">
            <div class="inline form-group">
                <select title="Race" name="race"><option>Auto</option></select>
                <input type="submit" id="add-entry" class="action" disabled value="Add Entry" />
                <button id="clear-crew" disabled>Clear</button>
            </div>
        </div>
    </div>
</form>
<script>

    function loadRaceNames() {
        google.script.run.withSuccessHandler(onRaceNamesLoaded).getRaceSheetNamesHTML(spreadSheetId);
    }

    function onRaceNamesLoaded(resp) {
        $.each(resp, function(i, name) {
            $('select[name=race]').append('<option>' + name + '</option>');
        });
    }

    function onAddCrewMember(e, customObj) {
        var selectedVals = customObj.selectedMembers;
        var rowHtml = selectedVals.map(function() { return '<tr>' +
                '<td><input type="hidden" name="entry" value="' + this.join('|') + '" />' +
                this[1] + ' ' + this[0] + '</td>' +
                '<td>' + this[2] + '</td>' +
                '<td>' + this[3] + '</td>' +
                '<td>' + this[6] + '</td>' +
                '</tr>';}).toArray();
        $('#crew-members').find('tbody').append(rowHtml);
        $('#add-entry, #clear-crew').prop('disabled', false);
    }

    function onClickAddCrew() {
        var selected = $('#crew-members').find('input[type=hidden]');
        var raceName = $('select[name=race]').val();
        if (selected.length > 0 && selected.length <= 2) {
            $('#crew-list-form').disableSubmit().trigger('crewSubmit', {
                raceName: raceName,
                crewMembers: selected.map(function(index, el) {
                    return [$(el).val().split('|')];
                }).toArray()
            });
        }
    }

    function onClickClearCrew() {
        $('#crew-members').find('tbody').empty();
        $('#add-entry, #clear-crew').prop('disabled', true);
    }

    /**
     * Fired when the submitted crew was processed successfully
     */
    function onCrewSubmitSuccess() {
        $(this).restoreSubmit();
        $('#crew-members').find('tbody').empty();
        $('#add-entry, #clear-crew').prop('disabled', true);
    }

    /**
     * Fired when a problem occurred processing the submitted crew
     */
    function onCrewSubmitFailure() {
        $(this).restoreSubmit();
    }

    $(function() {

        $('#crew-list-form')
            .on('crewMemberAdd', onAddCrewMember)
            .on('crewSubmitSuccess', onCrewSubmitSuccess)
            .on('crewSubmitFailure', onCrewSubmitFailure)
            .submit(function(event) {
                event.preventDefault();
                onClickAddCrew();
            });

        $('#clear-crew').click(onClickClearCrew);

        loadRaceNames();

    });
</script>